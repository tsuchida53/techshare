<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
    "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rugbyaholic.techshare.common.repositories.UserRepository">

	<select id="countUser" parameterType="com.rugbyaholic.techshare.manage.users.UserSearchForm"
			resultType="int">
	<![CDATA[
		SELECT  COUNT(*)
		FROM    USERS U
		INNER JOIN DEPTS DP
		ON      DP.DEPT_CD       =  U.DEPT_CD
		AND     DP.AVF          <=  CURDATE()
		AND     NOT EXISTS
		        (
		            SELECT  1
		            FROM    DEPTS
		            WHERE   DEPT_CD      =  DP.DEPT_CD
		            AND     AVF         <=  CURDATE()
		            AND     AVF          >  DP.AVF
		        )
		INNER JOIN POSITIONS POS
		ON      POS.POS_CD       =  U.POS_CD
		AND     POS.AVF         <=  CURDATE()
		AND     NOT EXISTS
		        (
		            SELECT  1
		            FROM    POSITIONS
		            WHERE   POS_CD       =  POS.POS_CD
		            AND     AVF         <=  CURDATE()
		            AND     AVF          >  POS.AVF
		        )
		WHERE   U.AVF           <=  CURDATE()
		AND     NOT EXISTS
		        (
		            SELECT  1
		            FROM    USERS
		            WHERE   EMAIL        =  U.EMAIL
		            AND     AVF         <=  CURDATE()
		            AND     AVF          >  U.AVF
		        )	
	]]>
	<if test="empNo != null">
	<![CDATA[
		AND    U.EMP_NO     =  #{empNo}
	]]>
	</if>
	<if test="name != null">
	<![CDATA[
		AND    U.NAME       =  #{name}
	]]>
	</if>
	<if test="deptCd != null">
	<![CDATA[
		AND    U.DEPT_CD    =  #{deptCd}
	]]>
	</if>
	<if test="posCd != null">
	<![CDATA[
		AND    U.POS_CD     =  #{posCd}
	]]>
	</if>
	</select>
	
	<select id="createProfileEditForm" parameterType="java.lang.Long" 
			resultType="com.rugbyaholic.techshare.auth.account.ProfileEditForm">
	<![CDATA[
		SELECT  ZIPCODE         AS zipcode,
		        PREF            AS pref,
		        CITY            AS city,
		        BLDG            AS bldg,
		        TELNO           AS phoneNo,
		        MOBILE_NO       AS mobilePhoneNo,
				USER_ID         AS userId
		FROM    PERSONAL_INFO
		WHERE   USER_ID      =  #{userId}
	]]>
	</select>
	
	<select id="identifyUser" parameterType="java.lang.String" resultMap="userDetails">
	<![CDATA[
		SELECT  
				a.ID,
				a.EMAIL,
				a.AVF,
				a.NAME,
				a.PASSWORD,
				a.LOCKED,
				a.EXPIRED,
				b.ROLE,
				c.CODE_NM,
				a.EMP_NO,
        		a.PROFILE_IMG,
        		d.DEPT_NM,
        		e.POS_NM
		FROM  	USERS a
		INNER JOIN	
			USER_ROLES b
		ON     b.USER_ID = a.ID
		INNER JOIN	 
			CODEMST c
		ON     c.CODE_ID   = 1
		AND    c.CODE	=	1
		INNER JOIN	
			DEPTS d
		ON      d.DEPT_CD	=	a.DEPT_CD
		INNER JOIN 
			POSITIONS e
		ON      e.POS_CD	=	a.POS_CD
					
		where	
			a.EMAIL       =		#{email}  
	]]>	
	</select>
	
	<resultMap type="com.rugbyaholic.techshare.auth.AuthenticatedUser" id="userDetails">
		<result property="id" column="ID" />
		<result property="email" column="EMAIL" />
		<result property="avf" column="AVF" />
		<result property="username" column="NAME" />
		<result property="password" column="PASSWORD" />
		<result property="locked" column="LOCKED" />
		<result property="expired" column="EXPIRED" />
		<!-- AS 2020.02.04 VOL007 -->
		<result property="empNo" column="EMP_NO" />
		<result property="deptName" column="DEPT_NM" />
		<result property="posName" column="POS_NM" />
		<association property="profileImage" javaType="com.rugbyaholic.techshare.common.ImageFile">
			<result property="fileName" column="PROFILE_IMG" />
		</association>
		<!-- AE 2020.02.04 VOL007 -->
		<collection property="roles" ofType="java.lang.String">
			<result column="CODE_NM" />
		</collection>
	</resultMap>
	
	<update id="changeProfile" parameterType="com.rugbyaholic.techshare.auth.AuthenticatedUser">
	<![CDATA[
		UPDATE  USERS
		SET     PASSWORD     =  #{password},
		        PROFILE_IMG  =  #{profileImage.fileName}
		WHERE   ID           =  #{id}
	]]>
	</update>
	
	<update id="updatePersonalInfo" parameterType="com.rugbyaholic.techshare.auth.account.ProfileEditForm">
	<![CDATA[
		INSERT INTO PERSONAL_INFO
		(USER_ID, ZIPCODE, PREF, CITY, BLDG, TELNO, MOBILE_NO)
		VALUES
		(#{userId}, #{zipcode}, #{pref}, #{city}, #{bldg}, #{phoneNo}, #{mobilePhoneNo})
		ON DUPLICATE KEY UPDATE  
		        ZIPCODE      =  #{zipcode},
		        PREF         =  #{pref},
		        CITY         =  #{city},
		        BLDG         =  #{bldg},
		        TELNO        =  #{phoneNo},
		        MOBILE_NO    =  #{mobilePhoneNo}
	]]>
	</update>
	
	<select id="loadUserList" parameterType="com.rugbyaholic.techshare.manage.users.UserSearchForm"
			resultType="com.rugbyaholic.techshare.auth.AuthenticatedUser">
	<![CDATA[
		SELECT  U.EMAIL                 AS email,
		        U.EMP_NO                AS empNo,
		        U.NAME                  AS username,
		        DP.DEPT_NM              AS deptName,
		        POS.POS_NM              AS posName
		FROM    USERS U
		INNER JOIN DEPTS DP
		ON      DP.DEPT_CD       =  U.DEPT_CD
		AND     DP.AVF          <=  CURDATE()
		AND     NOT EXISTS
		        (
		            SELECT  1
		            FROM    DEPTS
		            WHERE   DEPT_CD      =  DP.DEPT_CD
		            AND     AVF         <=  CURDATE()
		            AND     AVF          >  DP.AVF
		        )
		INNER JOIN POSITIONS POS
		ON      POS.POS_CD       =  U.POS_CD
		AND     POS.AVF         <=  CURDATE()
		AND     NOT EXISTS
		        (
		            SELECT  1
		            FROM    POSITIONS
		            WHERE   POS_CD       =  POS.POS_CD
		            AND     AVF         <=  CURDATE()
		            AND     AVF          >  POS.AVF
		        )
		WHERE   U.AVF           <=  CURDATE()
		AND     NOT EXISTS
		        (
		            SELECT  1
		            FROM    USERS
		            WHERE   EMAIL        =  U.EMAIL
		            AND     AVF         <=  CURDATE()
		            AND     AVF          >  U.AVF
		        )	
	]]>
	<if test="empNo != null">
	<![CDATA[
		AND    U.EMP_NO     =  #{empNo}
	]]>
	</if>
	<if test="name != null">
	<![CDATA[
		AND    U.NAME       =  #{name}
	]]>
	</if>
	<if test="deptCd != null">
	<![CDATA[
		AND    U.DEPT_CD    =  #{deptCd}
	]]>
	</if>
	<if test="posCd != null">
	<![CDATA[
		AND    U.POS_CD     =  #{posCd}
	]]>
	</if>
	<![CDATA[
		ORDER BY U.DEPT_CD, U.EMP_NO
		LIMIT  #{pageFrom}, #{count}
	]]>
	</select>
	
	<insert id="registerInitialUser" useGeneratedKeys="true" keyProperty="id">
	<![CDATA[
		INSERT INTO USERS (EMAIL, AVF, NAME, PASSWORD, LOCKED, EXPIRED, EMP_NO, DEPT_CD, POS_CD, PROFILE_IMG)
		VALUES (#{email}, CURDATE(), #{username}, #{password}, 0, 0, #{empNo}, '0000000', '0000', 'src/main/resources/static/img/anonymous.png')
	]]>
	</insert>
	
	<insert id="grantAuthority">
	<![CDATA[
		INSERT INTO USER_ROLES (USER_ID, ROLE, DELFLG)
		VALUES (#{user.id}, #{role}, '0')
	]]>
	</insert>
	
</mapper>