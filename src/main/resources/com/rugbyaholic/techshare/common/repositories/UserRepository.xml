<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
    "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rugbyaholic.techshare.common.repositories.UserRepository">
	
	<select id="createProfileEditForm" parameterType="java.lang.Long" 
			resultType="com.rugbyaholic.techshare.auth.account.ProfileEditForm">
	<![CDATA[
		SELECT  ZIPCODE         AS zipcode,
		        PREF            AS pref,
		        CITY            AS city,
		        BLDG            AS bldg,
		        TELNO           AS phoneNo,
		        MOBILE_NO       AS mobilePhoneNo,
				USER_ID         AS userId
		FROM    PERSONAL_INFO
		WHERE   USER_ID      =  #{userId}
	]]>
	</select>
	
	<select id="identifyUser" parameterType="java.lang.String" resultMap="userDetails">
	<![CDATA[
		SELECT  
				a.ID,
				a.EMAIL,
				a.AVF,
				a.NAME,
				a.PASSWORD,
				a.LOCKED,
				a.EXPIRED,
				b.ROLE,
				c.CODE_NM,
				a.EMP_NO,
        			a.PROFILE_IMG,
        			d.DEPT_NM,
        			e.POS_NM
		FROM  	USERS a
		INNER JOIN	
			USER_ROLES b
		ON     b.USER_ID = a.ID
		INNER JOIN	 
			CODEMST c
		ON     c.CODE_ID   = 1
		AND    c.CODE	=	1
		INNER JOIN	
			DEPTS d
		ON      d.DEPT_CD	=	a.DEPT_CD
		INNER JOIN 
			POSITIONS e
		ON      e.POS_CD	=	a.POS_CD
					
		where	
			a.EMAIL       =		#{email}  
	]]>	
	</select>
	
	<resultMap type="com.rugbyaholic.techshare.auth.AuthenticatedUser" id="userDetails">
		<result property="id" column="ID" />
		<result property="email" column="EMAIL" />
		<result property="avf" column="AVF" />
		<result property="username" column="NAME" />
		<result property="password" column="PASSWORD" />
		<result property="locked" column="LOCKED" />
		<result property="expired" column="EXPIRED" />
		<!-- AS 2020.02.04 VOL007 -->
		<result property="empNo" column="EMP_NO" />
		<result property="deptName" column="DEPT_NM" />
		<result property="posName" column="POS_NM" />
		<association property="profileImage" javaType="com.rugbyaholic.techshare.common.ImageFile">
			<result property="fileName" column="PROFILE_IMG" />
		</association>
		<!-- AE 2020.02.04 VOL007 -->
		<collection property="roles" ofType="java.lang.String">
			<result column="CODE_NM" />
		</collection>
	</resultMap>
	
	<update id="changeProfile" parameterType="com.rugbyaholic.techshare.auth.AuthenticatedUser">
	<![CDATA[
		UPDATE  USERS
		SET     PASSWORD     =  #{password},
		        PROFILE_IMG  =  #{profileImage.fileName}
		WHERE   ID           =  #{id}
	]]>
	</update>
	
	<update id="updatePersonalInfo" parameterType="com.rugbyaholic.techshare.auth.account.ProfileEditForm">
	<![CDATA[
		UPDATE  PERSONAL_INFO
		SET     ZIPCODE      =  #{zipcode},
		        PREF         =  #{pref},
		        CITY         =  #{city},
		        BLDG         =  #{bldg},
		        TELNO        =  #{phoneNo},
		        MOBILE_NO    =  #{mobilePhoneNo}
		WHERE   USER_ID      =  #{userId}
	]]>
	</update>
	
</mapper>